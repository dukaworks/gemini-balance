# Gemini Balance é¡¹ç›®æ¶æ„è¯´æ˜ä¹¦

## ğŸ“– ç›®å½•

1. [é¡¹ç›®å®šä½](#é¡¹ç›®å®šä½)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
4. [é¡¹ç›®æ¨¡å—ç»“æ„](#é¡¹ç›®æ¨¡å—ç»“æ„)
5. [æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§](#æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§)
6. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
7. [éƒ¨ç½²æ–¹å¼](#éƒ¨ç½²æ–¹å¼)
8. [å®‰å…¨ç‰¹æ€§](#å®‰å…¨ç‰¹æ€§)

---

## ğŸ¯ é¡¹ç›®å®šä½

**Gemini Balance** æ˜¯ä¸€ä¸ªåŸºäº Python FastAPI çš„ Google Gemini API ä»£ç†å’Œè´Ÿè½½å‡è¡¡å™¨ã€‚

### ä¸»è¦åŠŸèƒ½

- æ”¯æŒå¤šä¸ª Gemini API Key è¿›è¡Œè‡ªåŠ¨è½®è¯¢å’Œè´Ÿè½½å‡è¡¡
- å®ç° OpenAI API å…¼å®¹æ ¼å¼çš„ä»£ç†
- æä¾› Vertex AI Express API æ”¯æŒ
- åŒ…å«å›¾åƒç”Ÿæˆã€æ–‡æœ¬è½¬è¯­éŸ³ã€ç½‘ç»œæœç´¢ç­‰å¢å¼ºåŠŸèƒ½
- å®æ—¶ç›‘æ§ API Key çŠ¶æ€å’Œè¯·æ±‚ç»Ÿè®¡
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œè¯·æ±‚è¿½è¸ª

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å®¢æˆ·ç«¯è¯·æ±‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
    OpenAI API      Gemini API   Vertex API
    å…¼å®¹æ ¼å¼          åŸç”Ÿæ ¼å¼      Express
        â”‚                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   FastAPI åº”ç”¨å±‚        â”‚
        â”‚  (è·¯ç”±ã€ä¸­é—´ä»¶ã€å¤„ç†å™¨) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                â”‚                â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚  Service â”‚  â”‚  Handler   â”‚  â”‚  Schedulerâ”‚
â”‚  Layer   â”‚  â”‚  Layer     â”‚  â”‚  (ä»»åŠ¡)   â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚              â”‚                 â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚          æ•°æ®åº“å±‚ (SQLAlchemy)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ MySQL/SQLite å­˜å‚¨:               â”‚   â”‚
â”‚  â”‚ - Settings (é…ç½®è¡¨)              â”‚   â”‚
â”‚  â”‚ - ErrorLog (é”™è¯¯æ—¥å¿—)            â”‚   â”‚
â”‚  â”‚ - RequestLog (è¯·æ±‚æ—¥å¿—)          â”‚   â”‚
â”‚  â”‚ - FileRecord (æ–‡ä»¶è®°å½•)          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¯·æ±‚æµç¨‹

```
å®¢æˆ·ç«¯è¯·æ±‚
    â”‚
    â–¼
è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶ (request_logging_middleware)
    â”‚
    â–¼
æ™ºèƒ½è·¯ç”±ä¸­é—´ä»¶ (smart_routing_middleware)
    â”‚
    â–¼
è·¯ç”±åŒ¹é… (router)
    â”‚
    â–¼
è®¤è¯éªŒè¯ (verify_auth_token)
    â”‚
    â–¼
æœåŠ¡å±‚å¤„ç† (service layer)
    â”‚
    â”œâ”€ å¯†é’¥é€‰æ‹© (KeyManager)
    â”œâ”€ é‡è¯•é€»è¾‘ (retry_handler)
    â”œâ”€ æµä¼˜åŒ– (stream_optimizer)
    â”‚
    â–¼
APIè°ƒç”¨ (httpx/requests)
    â”‚
    â–¼
å“åº”å¤„ç† (response_handler)
    â”‚
    â–¼
è¿”å›å®¢æˆ·ç«¯
```

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæŠ€æœ¯

| å±‚çº§ | æŠ€æœ¯ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|------|
| **Webæ¡†æ¶** | FastAPI | 0.100+ | é«˜æ€§èƒ½å¼‚æ­¥Pythonæ¡†æ¶ |
| **æœåŠ¡å™¨** | Uvicorn | - | ASGIåº”ç”¨æœåŠ¡å™¨ |
| **Pythonç‰ˆæœ¬** | Python | 3.9+ | é¡¹ç›®æœ€ä½ç‰ˆæœ¬è¦æ±‚ |
| **ORM** | SQLAlchemy | - | Python SQLå·¥å…·åŒ…å’Œå¯¹è±¡å…³ç³»æ˜ å°„åº“ |
| **å¼‚æ­¥DB** | Databases | - | å¼‚æ­¥æ•°æ®åº“æ¥å£ |
| **æ•°æ®åº“** | MySQL/SQLite | - | æ”¯æŒä¸¤ç§å­˜å‚¨æ–¹æ¡ˆ |
| **å¼‚æ­¥é©±åŠ¨** | aiomysql/aiosqlite | - | å¼‚æ­¥æ•°æ®åº“è¿æ¥é©±åŠ¨ |
| **ä»»åŠ¡è°ƒåº¦** | APScheduler | - | å®šæ—¶ä»»åŠ¡è°ƒåº¦æ¡†æ¶ |
| **æ¨¡æ¿å¼•æ“** | Jinja2 | - | HTMLæ¨¡æ¿æ¸²æŸ“ |
| **HTTPå®¢æˆ·ç«¯** | httpx | - | ç°ä»£HTTPå®¢æˆ·ç«¯åº“ |
| **ä»£ç†æ”¯æŒ** | httpx[socks] | - | SOCKS5ä»£ç†æ”¯æŒ |
| **åŠ å¯†åº“** | cryptography | - | å¯†é’¥åŠ å¯†ä¸è§£å¯† |
| **é…ç½®ç®¡ç†** | pydantic_settings | - | ç±»å‹å®‰å…¨çš„é…ç½®ç®¡ç† |
| **æ•°æ®éªŒè¯** | pydantic | - | Pythonæ•°æ®éªŒè¯åº“ |
| **å®¹å™¨åŒ–** | Docker | - | æ”¯æŒAMD64/ARM64æ¶æ„ |
| **WebæœåŠ¡** | starlette | - | FastAPIåº•å±‚å¼‚æ­¥æ¡†æ¶ |

### ä¾èµ–åŒ…åˆ—è¡¨

```
fastapi              # FastAPIæ¡†æ¶
httpx[socks]         # HTTPå®¢æˆ·ç«¯+SOCKSä»£ç†
openai               # OpenAI SDK
pydantic             # æ•°æ®éªŒè¯
pydantic_settings    # é…ç½®ç®¡ç†
requests             # HTTPè¯·æ±‚
starlette            # å¼‚æ­¥æ¡†æ¶
uvicorn              # ASGIæœåŠ¡å™¨
google-genai         # Google Generative AI SDK
jinja2               # æ¨¡æ¿å¼•æ“
python-multipart     # å¤šéƒ¨åˆ†è¡¨å•æ•°æ®
cryptography         # åŠ å¯†åº“
pymysql              # MySQLé©±åŠ¨
sqlalchemy           # ORMæ¡†æ¶
aiomysql             # å¼‚æ­¥MySQLé©±åŠ¨
aiosqlite            # å¼‚æ­¥SQLiteé©±åŠ¨
databases             # å¼‚æ­¥æ•°æ®åº“æŠ½è±¡
python-dotenv        # .envæ–‡ä»¶åŠ è½½
apscheduler          # ä»»åŠ¡è°ƒåº¦
packaging            # ç‰ˆæœ¬ç®¡ç†
```

---

## ğŸ“ é¡¹ç›®æ¨¡å—ç»“æ„

### ç›®å½•æ ‘

```
app/
â”œâ”€â”€ main.py                          # åº”ç”¨å…¥å£ç‚¹
â”‚
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.py                   # Pydantic Settings é…ç½®ç±»
â”‚
â”œâ”€â”€ core/                            # æ ¸å¿ƒåº”ç”¨é€»è¾‘
â”‚   â”œâ”€â”€ application.py              # FastAPIåº”ç”¨åˆ›å»ºä¸ç”Ÿå‘½å‘¨æœŸ
â”‚   â”œâ”€â”€ constants.py                # å¸¸é‡å®šä¹‰
â”‚   â””â”€â”€ security.py                 # è®¤è¯æˆæƒé€»è¾‘
â”‚
â”œâ”€â”€ database/                        # æ•°æ®åº“æ“ä½œå±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ connection.py               # æ•°æ®åº“è¿æ¥ç®¡ç†
â”‚   â”œâ”€â”€ initialization.py           # æ•°æ®åº“è¡¨åˆå§‹åŒ–
â”‚   â”œâ”€â”€ models.py                   # SQLAlchemy ORMæ¨¡å‹
â”‚   â””â”€â”€ services.py                 # CRUDæ“ä½œæœåŠ¡
â”‚
â”œâ”€â”€ domain/                          # ä¸šåŠ¡é¢†åŸŸæ¨¡å‹
â”‚   â”œâ”€â”€ file_models.py              # æ–‡ä»¶ç›¸å…³æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ gemini_models.py            # Gemini APIæ¨¡å‹
â”‚   â”œâ”€â”€ image_models.py             # å›¾åƒå¤„ç†æ¨¡å‹
â”‚   â””â”€â”€ openai_models.py            # OpenAIå…¼å®¹æ¨¡å‹
â”‚
â”œâ”€â”€ exception/
â”‚   â””â”€â”€ exceptions.py               # è‡ªå®šä¹‰å¼‚å¸¸ç±»
â”‚
â”œâ”€â”€ handler/                         # è¯·æ±‚å¤„ç†é€»è¾‘
â”‚   â”œâ”€â”€ error_handler.py            # é”™è¯¯å¤„ç†
â”‚   â”œâ”€â”€ message_converter.py        # æ¶ˆæ¯æ ¼å¼è½¬æ¢
â”‚   â”œâ”€â”€ response_handler.py         # å“åº”æ ¼å¼åŒ–
â”‚   â”œâ”€â”€ retry_handler.py            # å¤±è´¥é‡è¯•é€»è¾‘
â”‚   â””â”€â”€ stream_optimizer.py         # æµå¼å“åº”ä¼˜åŒ–
â”‚
â”œâ”€â”€ log/
â”‚   â””â”€â”€ logger.py                   # æ—¥å¿—ç³»ç»Ÿé…ç½®
â”‚
â”œâ”€â”€ middleware/                      # FastAPIä¸­é—´ä»¶
â”‚   â”œâ”€â”€ middleware.py               # é€šç”¨ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ request_logging_middleware.py # è¯·æ±‚æ—¥å¿—è®°å½•
â”‚   â””â”€â”€ smart_routing_middleware.py  # æ™ºèƒ½URLæ˜ å°„
â”‚
â”œâ”€â”€ router/                          # APIè·¯ç”±å®šä¹‰
â”‚   â”œâ”€â”€ routes.py                   # è·¯ç”±èšåˆå…¥å£
â”‚   â”œâ”€â”€ config_routes.py            # é…ç½®ç®¡ç†æ¥å£
â”‚   â”œâ”€â”€ error_log_routes.py         # é”™è¯¯æ—¥å¿—æŸ¥è¯¢
â”‚   â”œâ”€â”€ files_routes.py             # æ–‡ä»¶ä¸Šä¼ /ç®¡ç†
â”‚   â”œâ”€â”€ gemini_routes.py            # Gemini APIç«¯ç‚¹
â”‚   â”œâ”€â”€ key_routes.py               # API Keyç®¡ç†
â”‚   â”œâ”€â”€ openai_compatiable_routes.py # OpenAIå…¼å®¹è·¯ç”±
â”‚   â”œâ”€â”€ openai_routes.py            # OpenAIåŸç”Ÿè·¯ç”±
â”‚   â”œâ”€â”€ scheduler_routes.py         # ä»»åŠ¡è°ƒåº¦
â”‚   â”œâ”€â”€ stats_routes.py             # ç»Ÿè®¡æ•°æ®æ¥å£
â”‚   â”œâ”€â”€ version_routes.py           # ç‰ˆæœ¬ä¿¡æ¯
â”‚   â””â”€â”€ vertex_express_routes.py    # Vertex Expressè·¯ç”±
â”‚
â”œâ”€â”€ scheduler/
â”‚   â””â”€â”€ scheduled_tasks.py          # å®šæ—¶ä»»åŠ¡å®šä¹‰
â”‚
â”œâ”€â”€ service/                         # ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”œâ”€â”€ gemini_chat_service.py          # GeminièŠå¤©æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ openai_chat_service.py          # OpenAIèŠå¤©æœåŠ¡
â”‚   â”‚   â””â”€â”€ vertex_express_chat_service.py  # Vertex ExpressèŠå¤©
â”‚   â”‚
â”‚   â”œâ”€â”€ client/
â”‚   â”‚   â””â”€â”€ api_client.py           # APIå®¢æˆ·ç«¯
â”‚   â”‚
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ config_service.py       # é…ç½®ç®¡ç†æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ embedding/
â”‚   â”‚   â”œâ”€â”€ embedding_service.py    # åµŒå…¥å‘é‡æœåŠ¡
â”‚   â”‚   â””â”€â”€ gemini_embedding_service.py # GeminiåµŒå…¥æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ error_log/
â”‚   â”‚   â””â”€â”€ error_log_service.py    # é”™è¯¯æ—¥å¿—æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ files/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ file_upload_handler.py  # æ–‡ä»¶ä¸Šä¼ å¤„ç†
â”‚   â”‚   â””â”€â”€ files_service.py        # æ–‡ä»¶ç®¡ç†æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ image/
â”‚   â”‚   â””â”€â”€ image_create_service.py # å›¾åƒç”ŸæˆæœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ key/
â”‚   â”‚   â””â”€â”€ key_manager.py          # API Keyç®¡ç†(è½®è¯¢ã€ç¦ç”¨)
â”‚   â”‚
â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â””â”€â”€ model_service.py        # æ¨¡å‹ç®¡ç†æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ openai_compatiable/
â”‚   â”‚   â””â”€â”€ openai_compatiable_service.py # OpenAIå…¼å®¹æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ proxy/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ proxy_check_service.py  # ä»£ç†æ£€æŸ¥ä¸é€‰æ‹©
â”‚   â”‚
â”‚   â”œâ”€â”€ request_log/
â”‚   â”‚   â””â”€â”€ request_log_service.py  # è¯·æ±‚æ—¥å¿—æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ stats/
â”‚   â”‚   â””â”€â”€ stats_service.py        # ç»Ÿè®¡æ•°æ®æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ tts/
â”‚   â”‚   â”œâ”€â”€ tts_service.py          # æ–‡æœ¬è½¬è¯­éŸ³æœåŠ¡
â”‚   â”‚   â””â”€â”€ native/                 # æœ¬åœ°TTSå®ç°
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ tts_chat_service.py
â”‚   â”‚       â”œâ”€â”€ tts_config.py
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”‚
â”‚   â””â”€â”€ update/
â”‚       â””â”€â”€ update_service.py       # ç‰ˆæœ¬æ›´æ–°æ£€æŸ¥
â”‚
â”œâ”€â”€ static/                          # å‰ç«¯é™æ€èµ„æº
â”‚   â”œâ”€â”€ manifest.json               # PWAæ¸…å•
â”‚   â”œâ”€â”€ service-worker.js           # Service Worker
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ fonts.css
â”‚   â”œâ”€â”€ icons/                      # åº”ç”¨å›¾æ ‡
â”‚   â””â”€â”€ js/
â”‚       â”œâ”€â”€ config_editor.js        # é…ç½®ç¼–è¾‘å™¨
â”‚       â”œâ”€â”€ error_logs.js           # é”™è¯¯æ—¥å¿—é¡µé¢è„šæœ¬
â”‚       â”œâ”€â”€ keys_status.js          # KeyçŠ¶æ€é¡µé¢è„šæœ¬
â”‚       â””â”€â”€ tailwindcss.js          # Tailwind CSS
â”‚
â”œâ”€â”€ templates/                       # HTMLæ¨¡æ¿
â”‚   â”œâ”€â”€ auth.html                   # è®¤è¯é¡µé¢
â”‚   â”œâ”€â”€ base.html                   # åŸºç¡€æ¨¡æ¿
â”‚   â”œâ”€â”€ config_editor.html          # é…ç½®ç¼–è¾‘å™¨é¡µé¢
â”‚   â”œâ”€â”€ error_logs.html             # é”™è¯¯æ—¥å¿—é¡µé¢
â”‚   â””â”€â”€ keys_status.html            # KeyçŠ¶æ€ç›‘æ§é¡µé¢
â”‚
â””â”€â”€ utils/                           # å·¥å…·å‡½æ•°
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ helpers.py                  # é€šç”¨åŠ©æ‰‹å‡½æ•°
    â”œâ”€â”€ static_version.py           # é™æ€æ–‡ä»¶ç‰ˆæœ¬ç®¡ç†
    â””â”€â”€ uploader.py                 # æ–‡ä»¶ä¸Šä¼ å·¥å…·

files/                              # ä¸Šä¼ æ–‡ä»¶ç›®å½•
tests/                              # å•å…ƒæµ‹è¯•
â”œâ”€â”€ __init__.py
â””â”€â”€ test_key_redaction.py          # å¯†é’¥è„±æ•æµ‹è¯•
```

### å…³é”®æ¨¡å—è¯´æ˜

#### ğŸ”§ **Configæ¨¡å—** (`app/config/config.py`)
- ä½¿ç”¨ Pydantic Settings ä».envæ–‡ä»¶è¯»å–é…ç½®
- æ”¯æŒç±»å‹éªŒè¯å’ŒåŠ¨æ€çƒ­æ›´æ–°
- ä¸»è¦é…ç½®é¡¹ï¼š
  - æ•°æ®åº“é…ç½® (DATABASE_TYPE, MYSQL_*, SQLITE_DATABASE)
  - APIé…ç½® (API_KEYS, VERTEX_API_KEYS, BASE_URL)
  - æ¨¡å‹é…ç½® (SEARCH_MODELS, IMAGE_MODELS, FILTERED_MODELS)
  - ä»£ç†é…ç½® (PROXIES, PROXIES_USE_CONSISTENCY_HASH_BY_API_KEY)
  - è¶…æ—¶å’Œé‡è¯• (TIME_OUT, MAX_RETRIES, MAX_FAILURES)

#### ğŸ¯ **Coreæ¨¡å—** (`app/core/`)
- `application.py`: åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–æ•°æ®åº“ã€è¿æ¥æ± ã€KeyManagerã€å®šæ—¶ä»»åŠ¡
  - åº”ç”¨å…³é—­æ—¶æ¸…ç†èµ„æº
- `security.py`: ä»¤ç‰ŒéªŒè¯å’Œè®¤è¯
- `constants.py`: å¸¸é‡å®šä¹‰

#### ğŸ—„ï¸ **Databaseæ¨¡å—** (`app/database/`)
- **SQLAlchemy ORM** å®šä¹‰æ•°æ®æ¨¡å‹
- **Databases** åº“æä¾›å¼‚æ­¥æ•°æ®åº“æ“ä½œ
- æ”¯æŒ MySQL å’Œ SQLite ä¸¤ç§æ•°æ®åº“
- ä¸»è¦è¡¨ï¼šSettingsã€ErrorLogã€RequestLogã€FileRecord

#### ğŸ”‘ **Serviceæ¨¡å—** (`app/service/`)
æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å±‚ï¼ŒåŒ…å«ï¼š

1. **ChatæœåŠ¡**: èŠå¤©æ¥å£å®ç°
   - Gemini Chat (google-genai SDK)
   - OpenAI Chat (OpenAI SDK)
   - Vertex Express Chat

2. **Keyç®¡ç†å™¨** (`key_manager.py`)
   - å•ä¾‹æ¨¡å¼ç®¡ç†API Key
   - æ”¯æŒè½®è¯¢ã€ç¦ç”¨ã€é‡ç½®
   - å¤±è´¥è®¡æ•°å’Œè‡ªåŠ¨ç¦ç”¨æœºåˆ¶

3. **ModelæœåŠ¡**: æ¨¡å‹åˆ—è¡¨ç®¡ç†
   - ä»APIè·å–æœ€æ–°æ¨¡å‹åˆ—è¡¨
   - æ”¯æŒæ¨¡å‹è¿‡æ»¤

4. **EmbeddingæœåŠ¡**: åµŒå…¥å‘é‡ç”Ÿæˆ
   - å…¼å®¹OpenAI embedding API

5. **ImageæœåŠ¡**: å›¾åƒç”Ÿæˆ
   - æ”¯æŒimagen-3.0-generate-002æ¨¡å‹
   - å…¼å®¹OpenAI image API

6. **å…¶ä»–æœåŠ¡**: ç»Ÿè®¡ã€æ—¥å¿—ã€é…ç½®ã€ä»£ç†ç­‰

#### ğŸ›£ï¸ **Routeræ¨¡å—** (`app/router/`)
å®šä¹‰äº†12ä¸ªè·¯ç”±æ¨¡å—ï¼Œå®ç°äº†ï¼š
- Gemini API åŸç”Ÿæ ¼å¼å’Œv1betaç‰ˆæœ¬
- OpenAI å…¼å®¹æ ¼å¼
- Vertex AI Express API
- é…ç½®ç®¡ç†æ¥å£
- KeyçŠ¶æ€ç›‘æ§
- é”™è¯¯æ—¥å¿—æŸ¥è¯¢
- æ–‡ä»¶ä¸Šä¼ 
- ç»Ÿè®¡æ•°æ®

#### âš™ï¸ **Handleræ¨¡å—** (`app/handler/`)
- **error_handler.py**: ç»Ÿä¸€é”™è¯¯å¤„ç†å’ŒHTTPå¼‚å¸¸æ˜ å°„
- **retry_handler.py**: å¤±è´¥é‡è¯•é€»è¾‘(æŒ‡æ•°é€€é¿)
- **stream_optimizer.py**: æµå¼å“åº”ä¼˜åŒ–(åˆ†å—ã€å»¶è¿Ÿè°ƒæ•´)
- **response_handler.py**: å“åº”æ ¼å¼åŒ–å’ŒåŒ…è£…
- **message_converter.py**: ä¸åŒAPIæ ¼å¼é—´çš„æ¶ˆæ¯è½¬æ¢

#### ğŸ”„ **Middlewareæ¨¡å—** (`app/middleware/`)
- **request_logging_middleware.py**: è®°å½•æ‰€æœ‰è¯·æ±‚æ—¥å¿—
- **smart_routing_middleware.py**: URLæ˜ å°„å’Œæ™ºèƒ½è·¯ç”±
- é€šç”¨ä¸­é—´ä»¶ï¼šé”™è¯¯å¤„ç†ã€CORSç­‰

#### â±ï¸ **Scheduleræ¨¡å—** (`app/scheduler/`)
å®šæ—¶ä»»åŠ¡åŒ…æ‹¬ï¼š
- KeyçŠ¶æ€æ£€æŸ¥ (å®šæœŸè°ƒç”¨TEST_MODEL)
- æ¨¡å‹åˆ—è¡¨æ›´æ–°
- å…¶ä»–ç›‘æ§ä»»åŠ¡

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

### 1. **å¤šKeyè´Ÿè½½å‡è¡¡**
```
å®ç°æ–¹å¼: KeyManagerç±»
åŠŸèƒ½:
  - è½®è¯¢é€‰æ‹©å¯ç”¨çš„API Key
  - è‡ªåŠ¨ç¦ç”¨å¤±è´¥è¶…è¿‡é˜ˆå€¼çš„Key
  - æ”¯æŒKeyé‡ç½®å’Œæ¢å¤
```

### 2. **è‡ªåŠ¨å¤±è´¥é‡è¯•**
```
å®ç°æ–¹å¼: retry_handler.py
ç­–ç•¥:
  - æœ€å¤§é‡è¯•æ¬¡æ•°: MAX_RETRIESé…ç½®
  - æŒ‡æ•°é€€é¿ç®—æ³•
  - å¤±è´¥è®¡æ•°è¶…è¿‡MAX_FAILURESè‡ªåŠ¨ç¦ç”¨Key
```

### 3. **æµå¼å“åº”ä¼˜åŒ–**
```
å®ç°æ–¹å¼: stream_optimizer.py
ä¼˜åŒ–:
  - åŠ¨æ€åˆ†å—å¤§å°è°ƒæ•´
  - è‡ªé€‚åº”å»¶è¿Ÿ
  - æ”¯æŒçŸ­æ–‡æœ¬å¿«é€Ÿå“åº”ã€é•¿æ–‡æœ¬ç¼“å†²
```

### 4. **å¤šæ¨¡å‹åŠŸèƒ½**
```
IMAGE_MODELS:
  - ä½¿ç”¨model-imageåç¼€è°ƒç”¨å›¾åƒç”Ÿæˆ
  - æ”¯æŒå›¾åƒç¼–è¾‘å’Œç†è§£

SEARCH_MODELS:
  - ä½¿ç”¨model-searchåç¼€è°ƒç”¨ç½‘ç»œæœç´¢
  - å®æ—¶æœç´¢å¢å¼ºå›ç­”

TOOLS_CODE_EXECUTION:
  - æ”¯æŒä»£ç æ‰§è¡Œèƒ½åŠ›
```

### 5. **APIå…¼å®¹æ€§**
```
æ”¯æŒå¤šç§APIæ ¼å¼:
  - Gemini åŸç”Ÿ API (google-genai)
  - OpenAI Chat Completion API
  - OpenAI Embeddings API
  - OpenAI Image Generation API
  - Vertex AI Express API
```

### 6. **å¯è§†åŒ–ç®¡ç†é¢æ¿**
```
Webç•Œé¢:
  - è®¤è¯ç™»å½•é¡µé¢ (/auth)
  - KeyçŠ¶æ€ç›‘æ§é¡µé¢ (/keys_status)
  - é…ç½®ç¼–è¾‘å™¨ (/config_editor)
  - é”™è¯¯æ—¥å¿—æŸ¥çœ‹ (/error_logs)
  
å®æ—¶æ›´æ–°:
  - é…ç½®ä¿®æ”¹å³æ—¶ç”Ÿæ•ˆ(æ— éœ€é‡å¯)
  - å®æ—¶KeyçŠ¶æ€æ˜¾ç¤º
```

### 7. **ä»£ç†æ”¯æŒ**
```
å®ç°æ–¹å¼: proxy_check_service.py
ç‰¹æ€§:
  - æ”¯æŒ HTTP å’Œ SOCKS5 ä»£ç†
  - ä¸€è‡´æ€§å“ˆå¸Œé€‰æ‹© (PROXIES_USE_CONSISTENCY_HASH_BY_API_KEY)
  - ä»£ç†è½®è¯¢
```

### 8. **è¯¦ç»†æ—¥å¿—ç³»ç»Ÿ**
```
è®°å½•å†…å®¹:
  - è¯·æ±‚æ—¥å¿—: æ¨¡å‹ã€Keyã€çŠ¶æ€ç ã€å»¶è¿Ÿ
  - é”™è¯¯æ—¥å¿—: é”™è¯¯ç±»å‹ã€å †æ ˆã€è¯·æ±‚å†…å®¹
  - è®¿é—®æ—¥å¿—: æ‰€æœ‰HTTPè¯·æ±‚

æŸ¥è¯¢æ¥å£:
  - /error_logs: æŸ¥çœ‹é”™è¯¯æ—¥å¿—
  - /stats: æŸ¥çœ‹ç»Ÿè®¡æ•°æ®
  - /keys_status: æŸ¥çœ‹KeyçŠ¶æ€
```

### 9. **æ–‡ä»¶å¤„ç†**
```
åŠŸèƒ½:
  - ä¸Šä¼ æ–‡ä»¶åˆ°Gemini
  - å­˜å‚¨æ–‡ä»¶å…ƒæ•°æ®(åç§°ã€å¤§å°ã€MIMEç±»å‹ã€SHA256å“ˆå¸Œ)
  - æ–‡ä»¶çŠ¶æ€è·Ÿè¸ª(PROCESSING, ACTIVE, FAILED)
  - è¿‡æœŸæ—¶é—´ç®¡ç†
```

### 10. **TTSæœåŠ¡**
```
å®ç°æ–¹å¼: service/tts/
åŠŸèƒ½:
  - æ–‡æœ¬è½¬è¯­éŸ³
  - æ”¯æŒå¤šç§è¯­è¨€å’Œè¯­éŸ³
  - æœ¬åœ°å’Œäº‘ç«¯å®ç°
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### è¡¨ç»“æ„

#### **Settingsè¡¨** (`t_settings`)
å­˜å‚¨åŠ¨æ€é…ç½®é¡¹ï¼Œæ”¯æŒWebç•Œé¢ä¿®æ”¹
```sql
CREATE TABLE t_settings (
    id INT PRIMARY KEY AUTO_INCREMENT,
    key VARCHAR(100) UNIQUE NOT NULL,      -- é…ç½®é”®
    value TEXT,                            -- é…ç½®å€¼
    description VARCHAR(255),              -- æè¿°
    created_at DATETIME DEFAULT NOW(),
    updated_at DATETIME DEFAULT NOW()
);
```

#### **ErrorLogè¡¨** (`t_error_logs`)
è®°å½•æ‰€æœ‰APIè°ƒç”¨é”™è¯¯
```sql
CREATE TABLE t_error_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    gemini_key VARCHAR(100),               -- ä½¿ç”¨çš„API Key
    model_name VARCHAR(100),               -- æ¨¡å‹åç§°
    error_type VARCHAR(50),                -- é”™è¯¯ç±»å‹
    error_log TEXT,                        -- é”™è¯¯å †æ ˆä¿¡æ¯
    error_code INT,                        -- é”™è¯¯ä»£ç 
    request_msg JSON,                      -- è¯·æ±‚å†…å®¹
    request_time DATETIME DEFAULT NOW()
);
```

#### **RequestLogè¡¨** (`t_request_log`)
è®°å½•æ‰€æœ‰APIè¯·æ±‚ç»Ÿè®¡
```sql
CREATE TABLE t_request_log (
    id INT PRIMARY KEY AUTO_INCREMENT,
    request_time DATETIME DEFAULT NOW(),   -- è¯·æ±‚æ—¶é—´
    model_name VARCHAR(100),               -- æ¨¡å‹åç§°
    api_key VARCHAR(100),                  -- ä½¿ç”¨çš„Key
    is_success BOOLEAN NOT NULL,           -- æ˜¯å¦æˆåŠŸ
    status_code INT,                       -- HTTPçŠ¶æ€ç 
    latency_ms INT                         -- å“åº”å»¶è¿Ÿ(ms)
);
```

#### **FileRecordè¡¨** (`t_file_records`)
è®°å½•ä¸Šä¼ åˆ°Geminiçš„æ–‡ä»¶ä¿¡æ¯
```sql
CREATE TABLE t_file_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) UNIQUE NOT NULL,     -- æ–‡ä»¶å (files/{file_id})
    display_name VARCHAR(255),             -- åŸå§‹æ–‡ä»¶å
    mime_type VARCHAR(100) NOT NULL,       -- MIMEç±»å‹
    size_bytes BIGINT NOT NULL,            -- æ–‡ä»¶å¤§å°
    sha256_hash VARCHAR(255),              -- SHA256å“ˆå¸Œ
    state ENUM('PROCESSING', 'ACTIVE', 'FAILED'),
    create_time DATETIME NOT NULL,
    update_time DATETIME NOT NULL,
    expiration_time DATETIME NOT NULL,     -- è¿‡æœŸæ—¶é—´
    uri VARCHAR(500) NOT NULL,             -- è®¿é—®URI
    api_key VARCHAR(100) NOT NULL,         -- ä¸Šä¼ æ—¶ä½¿ç”¨çš„Key
    upload_url TEXT                        -- ä¸´æ—¶ä¸Šä¼ URL
);
```

### å…³é”®è®¾è®¡ç‚¹

1. **æ€§èƒ½ä¼˜åŒ–**
   - åˆç†ç´¢å¼•è®¾è®¡ (uniqueã€foreign key)
   - JSONå­—æ®µå­˜å‚¨çµæ´»æ•°æ®
   - æ—¶é—´æˆ³è‡ªåŠ¨æ›´æ–°

2. **æ•°æ®éš”ç¦»**
   - æ¯ä¸ªKeyã€æ¨¡å‹çš„è¯·æ±‚å’Œé”™è¯¯åˆ†åˆ«è®°å½•
   - æ”¯æŒæŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢

3. **å¯æ‰©å±•æ€§**
   - JSONå­—æ®µå­˜å‚¨è¯·æ±‚è¯¦æƒ…ï¼Œé¿å…é¢‘ç¹æ”¹è¡¨
   - FileStateæšä¸¾æ”¯æŒæ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†

---

## ğŸš€ éƒ¨ç½²æ–¹å¼

### æ–¹å¼1: Docker Compose (æ¨è)

```bash
# 1. ä¸‹è½½docker-compose.yml
# 2. å¤åˆ¶.env.exampleåˆ°.envï¼Œé…ç½®å‚æ•°
# 3. å¯åŠ¨æœåŠ¡
docker-compose up -d
```

**docker-compose.ymlç‰¹æ€§**:
- æ”¯æŒMySQLæ•°æ®åº“æœåŠ¡
- æ”¯æŒå¤šæ¶æ„é•œåƒ (AMD64/ARM64)
- ç¯å¢ƒå˜é‡é…ç½®

### æ–¹å¼2: Dockerå•å®¹å™¨

```bash
# æ‹‰å–é•œåƒ
docker pull ghcr.io/snailyp/gemini-balance:latest

# è¿è¡Œå®¹å™¨
docker run -d \
  -p 8000:8000 \
  -e API_KEYS='["key1","key2"]' \
  -e DATABASE_TYPE=sqlite \
  ghcr.io/snailyp/gemini-balance:latest
```

### æ–¹å¼3: æœ¬åœ°Pythonè¿è¡Œ

```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. é…ç½®.envæ–‡ä»¶
# 3. åˆå§‹åŒ–æ•°æ®åº“
# 4. è¿è¡Œåº”ç”¨
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### ç¯å¢ƒå˜é‡é…ç½®

| å˜é‡ | è¯´æ˜ | ä¾‹å€¼ |
|------|------|------|
| `API_KEYS` | Gemini API Keyåˆ—è¡¨ | `["key1","key2"]` |
| `VERTEX_API_KEYS` | Vertex API Keyåˆ—è¡¨ | `["key1"]` |
| `ALLOWED_TOKENS` | è®¤è¯ä»¤ç‰Œç™½åå• | `["token1"]` |
| `AUTH_TOKEN` | ç®¡ç†å‘˜ä»¤ç‰Œ | `admin_token` |
| `DATABASE_TYPE` | æ•°æ®åº“ç±»å‹ | `mysql` æˆ– `sqlite` |
| `MYSQL_HOST` | MySQLä¸»æœº | `localhost` |
| `MYSQL_PORT` | MySQLç«¯å£ | `3306` |
| `MYSQL_DATABASE` | æ•°æ®åº“å | `gemini_balance` |
| `MAX_RETRIES` | æœ€å¤§é‡è¯•æ¬¡æ•° | `3` |
| `MAX_FAILURES` | Keyè‡ªåŠ¨ç¦ç”¨é˜ˆå€¼ | `3` |
| `SEARCH_MODELS` | æ”¯æŒæœç´¢çš„æ¨¡å‹ | `["gemini-2.5-flash"]` |
| `IMAGE_MODELS` | æ”¯æŒå›¾åƒçš„æ¨¡å‹ | `["gemini-2.0-flash-exp"]` |
| `PROXIES` | ä»£ç†åˆ—è¡¨ | `["http://proxy:8080"]` |

---

## ğŸ” å®‰å…¨ç‰¹æ€§

### 1. **èº«ä»½è®¤è¯**
- ä»¤ç‰Œè®¤è¯ (AUTH_TOKEN)
- è¯·æ±‚ç™½åå• (ALLOWED_TOKENS)
- ç®¡ç†å‘˜Session (ADMIN_SESSION_EXPIRE)

### 2. **API Keyä¿æŠ¤**
- åŠ å¯†å­˜å‚¨ (cryptographyåº“)
- æ—¥å¿—ä¸­è‡ªåŠ¨è„±æ•
- Keyè½®è¯¢éšè—å®ç°ç»†èŠ‚

### 3. **è¯·æ±‚éªŒè¯**
- Pydanticæ¨¡å‹éªŒè¯è¾“å…¥
- è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†
- é”™è¯¯æ¶ˆæ¯ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯

### 4. **ä¸­é—´ä»¶å®‰å…¨**
- CORSé…ç½®
- è¯·æ±‚å¤§å°é™åˆ¶
- é€Ÿç‡é™åˆ¶æ”¯æŒ

### 5. **æ—¥å¿—å®‰å…¨**
- æ•æ„Ÿä¿¡æ¯è„±æ•
- é”™è¯¯æ—¥å¿—éš”ç¦»
- å¯å®¡è®¡çš„è¯·æ±‚è¿½è¸ª

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. **å¼‚æ­¥å¤„ç†**
- å…¨å¼‚æ­¥æ¶æ„ (FastAPI + asyncio)
- æ•°æ®åº“å¼‚æ­¥é©±åŠ¨ (aiomysql/aiosqlite)
- HTTPå¼‚æ­¥å®¢æˆ·ç«¯ (httpx)

### 2. **è¿æ¥æ± **
- æ•°æ®åº“è¿æ¥å¤ç”¨
- ä¸€è‡´æ€§å“ˆå¸Œä»£ç†é€‰æ‹©
- é•¿è¿æ¥ç®¡ç†

### 3. **ç¼“å­˜æœºåˆ¶**
- æ¨¡å‹åˆ—è¡¨ç¼“å­˜
- KeyçŠ¶æ€ç¼“å­˜
- é…ç½®çƒ­æ›´æ–°

### 4. **æµä¼˜åŒ–**
- æ™ºèƒ½åˆ†å—å¤§å°
- è‡ªé€‚åº”å»¶è¿Ÿ
- åŠæ—¶å“åº”æœºåˆ¶

### 5. **ç›‘æ§æŒ‡æ ‡**
- è¯·æ±‚å»¶è¿Ÿè®°å½•
- KeyæˆåŠŸç‡ç»Ÿè®¡
- æ¨¡å‹ä½¿ç”¨åˆ†æ

---

## ğŸ”„ è¯·æ±‚å¤„ç†æµç¨‹è¯¦è§£

### Chatè¯·æ±‚å¤„ç†æµç¨‹

```
POST /v1/chat/completions
    â”‚
    â–¼
request_logging_middleware
(è®°å½•è¯·æ±‚ä¿¡æ¯)
    â”‚
    â–¼
smart_routing_middleware
(URLæ˜ å°„å¤„ç†)
    â”‚
    â–¼
openai_routes.py/gemini_routes.py
(è·¯ç”±åŒ¹é…)
    â”‚
    â–¼
verify_auth_token()
(è®¤è¯éªŒè¯)
    â”‚
    â–¼
openai_chat_service / gemini_chat_service
(ä¸šåŠ¡é€»è¾‘)
    â”‚
    â”œâ”€ message_converter (æ ¼å¼è½¬æ¢)
    â”œâ”€ key_manager (é€‰æ‹©API Key)
    â”‚
    â–¼
retry_handler
(å¤±è´¥é‡è¯•)
    â”‚
    â”œâ”€ api_client.call_api()
    â”‚  â””â”€ httpxè¯·æ±‚
    â”‚
    â”œâ”€ å¤±è´¥æ—¶é€’å½’é‡è¯•
    â”‚
    â–¼
stream_optimizer
(æµä¼˜åŒ–)
    â”‚
    â”œâ”€ åˆ†å—å¤„ç†
    â”œâ”€ å»¶è¿Ÿè°ƒæ•´
    â”‚
    â–¼
response_handler
(å“åº”æ ¼å¼åŒ–)
    â”‚
    â–¼
è¿”å›å®¢æˆ·ç«¯
    â”‚
    â–¼
request_logging_middleware
(è®°å½•å“åº”æ—¥å¿—)
```

---

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„ChatæœåŠ¡

1. åœ¨ `service/chat/` ä¸‹åˆ›å»ºæ–°çš„æœåŠ¡ç±»
2. ç»§æ‰¿åŸºç¡€æ¥å£æˆ–å‚è€ƒç°æœ‰å®ç°
3. åœ¨è·¯ç”±å±‚åˆ›å»ºå¯¹åº”çš„ç«¯ç‚¹
4. åœ¨é…ç½®ä¸­æ·»åŠ ç›¸å…³å‚æ•°

### æ·»åŠ æ–°çš„APIç«¯ç‚¹

1. åœ¨ `router/` ç›®å½•åˆ›å»ºæ–°çš„è·¯ç”±æ–‡ä»¶
2. å®šä¹‰FastAPIè·¯ç”±å’ŒPydanticæ¨¡å‹
3. åœ¨ `router/routes.py` ä¸­æ³¨å†Œè·¯ç”±
4. æ·»åŠ ç›¸åº”çš„æœåŠ¡å±‚é€»è¾‘

### æ·»åŠ å®šæ—¶ä»»åŠ¡

1. åœ¨ `scheduler/scheduled_tasks.py` ä¸­å®šä¹‰ä»»åŠ¡å‡½æ•°
2. ä½¿ç”¨APSchedulerè£…é¥°å™¨é…ç½®è°ƒåº¦
3. åœ¨åº”ç”¨å¯åŠ¨æ—¶æ³¨å†Œåˆ°è°ƒåº¦å™¨

### æ•°æ®åº“æ“ä½œ

1. åœ¨ `database/models.py` ä¸­å®šä¹‰SQLAlchemyæ¨¡å‹
2. åœ¨ `database/services.py` ä¸­å®ç°CRUDæ“ä½œ
3. ä½¿ç”¨å¼‚æ­¥æ¥å£ (await)

---

## ğŸ“ é…ç½®æ–‡ä»¶ç¤ºä¾‹

### .env é…ç½®ç¤ºä¾‹

```env
# æ•°æ®åº“é…ç½®
DATABASE_TYPE=mysql
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=password
MYSQL_DATABASE=gemini_balance

# APIé…ç½®
API_KEYS=["sk-xxx-1", "sk-xxx-2"]
VERTEX_API_KEYS=["vertex-key-1"]
BASE_URL=https://generativelanguage.googleapis.com/v1beta

# è®¤è¯é…ç½®
AUTH_TOKEN=admin_secret_token
ALLOWED_TOKENS=["token1", "token2"]
ADMIN_SESSION_EXPIRE=3600

# æ¨¡å‹é…ç½®
SEARCH_MODELS=["gemini-2.5-flash", "gemini-2.5-pro"]
IMAGE_MODELS=["gemini-2.0-flash-exp", "gemini-2.5-flash-image-preview"]
TOOLS_CODE_EXECUTION_ENABLED=true

# æ€§èƒ½é…ç½®
MAX_RETRIES=3
MAX_FAILURES=3
TIME_OUT=120
PROXIES=["http://proxy.example.com:8080"]
PROXIES_USE_CONSISTENCY_HASH_BY_API_KEY=true

# ç‰¹æ€§å¼€å…³
URL_NORMALIZATION_ENABLED=false
```

---

## ğŸ“ å…³é”®è®¾è®¡æ¨¡å¼

### 1. **å•ä¾‹æ¨¡å¼** (KeyManager)
```python
# å…¨å±€å”¯ä¸€çš„Keyç®¡ç†å™¨å®ä¾‹
key_manager = await get_key_manager_instance(keys)
```

### 2. **æœåŠ¡æ³¨å…¥**
```python
# é€šè¿‡ä¾èµ–æ³¨å…¥è·å–æœåŠ¡
async def handler(service: ChatService = Depends()):
    pass
```

### 3. **ä¸­é—´ä»¶é“¾**
```python
# å¤šä¸ªä¸­é—´ä»¶å †å å¤„ç†è¯·æ±‚
app.add_middleware(RequestLoggingMiddleware)
app.add_middleware(SmartRoutingMiddleware)
```

### 4. **å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†**
```python
# ç”Ÿå‘½å‘¨æœŸç®¡ç†
@asynccontextmanager
async def lifespan(app: FastAPI):
    # å¯åŠ¨
    yield
    # å…³é—­
```

### 5. **ç­–ç•¥æ¨¡å¼**
```python
# ä¸åŒçš„ChatæœåŠ¡å®ç°
class ChatService(ABC):
    async def chat(self): pass

class GeminiChatService(ChatService): ...
class OpenAIChatService(ChatService): ...
```

---

## ğŸ“ APIç«¯ç‚¹æ€»è§ˆ

### Gemini API
- `POST /v1beta/models/{model}:generateContent`
- `POST /v1beta/models/{model}:streamGenerateContent`

### OpenAI API
- `POST /v1/chat/completions`
- `POST /v1/embeddings`
- `POST /v1/images/generations`

### Vertex Express API
- `POST /v1beta1/publishers/google/models/{model}:streamGenerateContent`

### ç®¡ç†æ¥å£
- `GET /keys_status` - KeyçŠ¶æ€ç›‘æ§
- `GET /config_editor` - é…ç½®ç¼–è¾‘å™¨
- `GET /error_logs` - é”™è¯¯æ—¥å¿—
- `GET /stats` - ç»Ÿè®¡æ•°æ®
- `POST /auth` - è®¤è¯

### æ–‡ä»¶æ“ä½œ
- `POST /upload` - ä¸Šä¼ æ–‡ä»¶
- `GET /files/{file_id}` - æŸ¥è¯¢æ–‡ä»¶

---

## ğŸš¨ å¸¸è§é—®é¢˜æ’æŸ¥

### 1. Keyé¢‘ç¹è¢«ç¦ç”¨
- æ£€æŸ¥KEYçš„é…é¢æ˜¯å¦å·²ç”¨å°½
- æŸ¥çœ‹error_logsäº†è§£å…·ä½“é”™è¯¯
- è°ƒæ•´MAX_FAILURESé˜ˆå€¼

### 2. è¯·æ±‚è¶…æ—¶
- å¢åŠ TIME_OUTé…ç½®
- æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œä»£ç†é…ç½®
- æŸ¥çœ‹è¯·æ±‚æ—¥å¿—ä¸­çš„å»¶è¿Ÿ

### 3. æ•°æ®åº“è¿æ¥å¤±è´¥
- éªŒè¯DATABASE_TYPEé…ç½®
- æ£€æŸ¥MySQL/SQLiteè¿æ¥å‚æ•°
- æŸ¥çœ‹åº”ç”¨å¯åŠ¨æ—¥å¿—

### 4. æ¨¡å‹ä¸å¯ç”¨
- æ£€æŸ¥FILTERED_MODELSé…ç½®
- ç¡®ä¿API_KEYSæœ‰æƒé™è®¿é—®è¯¥æ¨¡å‹
- æ›´æ–°æ¨¡å‹åˆ—è¡¨

---

## ğŸ“š å‚è€ƒèµ„æº

- FastAPI å®˜æ–¹æ–‡æ¡£: https://fastapi.tiangolo.com/
- SQLAlchemy æ–‡æ¡£: https://docs.sqlalchemy.org/
- Google Generative AI API: https://ai.google.dev/
- OpenAI API: https://platform.openai.com/docs/
- Vertex AI æ–‡æ¡£: https://cloud.google.com/vertex-ai/docs

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¶é—´**: 2025-11-13  
**ç»´æŠ¤è€…**: Gemini Balance é¡¹ç›®å›¢é˜Ÿ
